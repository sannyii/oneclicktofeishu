<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容提取测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .nav {
            background: #e9ecef;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .main-content {
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .sidebar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            float: right;
            width: 200px;
            margin-left: 20px;
        }
        .footer {
            background: #343a40;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .highlight {
            background: #fff3cd;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        .content-area {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-button {
            background: #3370ff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #2860e1;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>内容提取功能测试页面</h1>
        <p>这个页面用于测试插件的内容提取功能，确保能够全选页面所有相关内容。</p>
    </div>
    
    <div class="nav">
        <a href="#">首页</a> | 
        <a href="#">关于</a> | 
        <a href="#">联系</a> | 
        <a href="#">帮助</a>
    </div>
    
    <div class="sidebar">
        <h3>侧边栏</h3>
        <p>这是侧边栏内容，应该被过滤掉。</p>
        <ul>
            <li>相关链接1</li>
            <li>相关链接2</li>
            <li>相关链接3</li>
        </ul>
    </div>
    
    <div class="main-content">
        <h2>主要文章内容</h2>
        
        <div class="content-area">
            <h3>人工智能在医疗领域的应用前景</h3>
            <p>随着技术的快速发展，人工智能在医疗领域的应用越来越广泛。从诊断辅助到药物研发，AI技术正在改变传统医疗模式。</p>
            
            <div class="highlight">
                <h4>核心要点</h4>
                <p>AI在医疗领域的应用主要包括：医学影像诊断、个性化治疗方案、药物研发加速、医疗资源优化等。</p>
            </div>
            
            <h4>主要应用领域</h4>
            <p><strong>医学影像诊断：</strong>AI在医学影像分析方面表现出色，能够快速准确地识别X光片、CT扫描和MRI图像中的异常。研究表明，AI在某些疾病的诊断准确率已经达到或超过人类专家水平。</p>
            
            <p><strong>药物研发：</strong>人工智能可以加速药物发现过程，通过分析大量分子数据来预测新药物的有效性和安全性。这大大缩短了药物从实验室到市场的开发周期。</p>
            
            <p><strong>个性化医疗：</strong>基于患者的基因信息、病史和生活习惯，AI可以为每个患者制定个性化的治疗方案，提高治疗效果并减少副作用。</p>
        </div>
        
        <div class="test-section">
            <h3>技术实现细节</h3>
            <p>现代AI医疗系统通常采用深度学习算法，结合大数据分析技术，能够处理海量的医疗数据。这些系统不仅能够提供诊断建议，还能够预测疾病发展趋势，为预防医学提供重要支持。</p>
            
            <ul>
                <li>机器学习算法优化</li>
                <li>大数据处理能力</li>
                <li>实时分析功能</li>
                <li>多模态数据融合</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>挑战与机遇</h3>
            <p>尽管AI在医疗领域展现出巨大潜力，但仍面临数据隐私、算法透明度、监管合规等挑战。同时，这也为医疗行业带来了前所未有的发展机遇。</p>
            
            <p>未来，随着技术的不断进步和政策的完善，人工智能将在医疗领域发挥更加重要的作用，为人类健康事业做出更大贡献。</p>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2024 内容提取测试页面 - 这是页脚内容，应该被过滤掉</p>
    </div>
    
    <div style="clear: both; margin-top: 30px;">
        <h3>测试功能</h3>
        <button class="test-button" onclick="testContentExtraction()">测试内容提取</button>
        <button class="test-button" onclick="showPageStructure()">显示页面结构</button>
        <button class="test-button" onclick="clearResults()">清除结果</button>
        
        <div id="results" class="result" style="display: none;"></div>
    </div>

    <script>
        // 模拟内容提取功能
        function extractPageContent() {
            // 获取页面标题
            const title = document.title || '';
            
            // 获取页面URL
            const url = window.location.href;
            
            // 提取主要文本内容
            let content = '';
            
            // 扩展的文章内容选择器，确保全选页面所有内容
            const articleSelectors = [
                'article',
                '[role="main"]',
                '.content',
                '.post-content',
                '.article-content',
                '.entry-content',
                '.post-body',
                '.article-body',
                '.main-content',
                '.page-content',
                '.story-content',
                '.text-content',
                '.body-content',
                '.content-area',
                '.content-wrapper',
                '.main',
                '.main-area',
                '.primary-content',
                '.primary',
                '.container',
                '.wrapper'
            ];
            
            let mainContent = null;
            
            // 首先尝试找到特定的内容区域
            for (const selector of articleSelectors) {
                const element = document.querySelector(selector);
                if (element) {
                    // 检查元素是否有足够的文本内容
                    const textContent = element.textContent.trim();
                    if (textContent.length > 100) { // 确保有足够的内容
                        mainContent = element;
                        console.log('找到内容区域:', selector);
                        break;
                    }
                }
            }
            
            // 如果没有找到特定的内容区域，尝试更智能的选择
            if (!mainContent) {
                // 查找包含最多文本的元素
                const candidates = document.querySelectorAll('div, section, main, article');
                let bestCandidate = null;
                let maxTextLength = 0;
                
                candidates.forEach(element => {
                    const textContent = element.textContent.trim();
                    // 排除导航、页脚、侧边栏等
                    const className = element.className.toLowerCase();
                    const id = element.id.toLowerCase();
                    
                    if (!className.includes('nav') && 
                        !className.includes('footer') && 
                        !className.includes('sidebar') && 
                        !className.includes('header') &&
                        !id.includes('nav') && 
                        !id.includes('footer') && 
                        !id.includes('sidebar') && 
                        !id.includes('header') &&
                        textContent.length > maxTextLength &&
                        textContent.length > 200) { // 至少200字符
                        maxTextLength = textContent.length;
                        bestCandidate = element;
                    }
                });
                
                if (bestCandidate) {
                    mainContent = bestCandidate;
                    console.log('选择最佳内容区域:', bestCandidate.tagName, bestCandidate.className);
                }
            }
            
            // 如果还是没有找到合适的内容区域，使用body
            if (!mainContent) {
                mainContent = document.body;
                console.log('使用body作为内容区域');
            }
            
            // 提取文本内容，过滤掉脚本和样式
            const walker = document.createTreeWalker(
                mainContent,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // 跳过脚本和样式标签中的文本
                        const parent = node.parentElement;
                        if (parent && (parent.tagName === 'SCRIPT' || parent.tagName === 'STYLE')) {
                            return NodeFilter.FILTER_REJECT;
                        }
                        
                        // 跳过导航、页脚、侧边栏等
                        if (parent) {
                            const className = parent.className.toLowerCase();
                            const id = parent.id.toLowerCase();
                            if (className.includes('nav') || 
                                className.includes('footer') || 
                                className.includes('sidebar') || 
                                className.includes('header') ||
                                id.includes('nav') || 
                                id.includes('footer') || 
                                id.includes('sidebar') || 
                                id.includes('header')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                        }
                        
                        return NodeFilter.FILTER_ACCEPT;
                    }
                }
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                const text = node.textContent.trim();
                if (text.length > 5) { // 降低最小长度要求，确保获取更多内容
                    textNodes.push(text);
                }
            }
            
            content = textNodes.join('\n\n');
            
            // 如果内容太少，尝试获取更多内容
            if (content.length < 500) {
                console.log('内容太少，尝试获取更多内容');
                // 直接获取body的所有文本内容
                const bodyText = document.body.textContent.trim();
                const lines = bodyText.split('\n').filter(line => line.trim().length > 10);
                content = lines.join('\n\n');
            }
            
            // 清理内容：移除多余的空白字符
            content = content.replace(/\s+/g, ' ').trim();
            
            // 限制内容长度，避免API调用过大
            if (content.length > 12000) { // 增加内容长度限制
                content = content.substring(0, 12000) + '...';
                console.log('内容已截断到12000字符');
            }
            
            console.log('提取的内容长度:', content.length);
            console.log('内容预览:', content.substring(0, 200) + '...');
            
            return {
                title,
                url,
                content
            };
        }
        
        function testContentExtraction() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '正在提取内容...';
            
            setTimeout(() => {
                try {
                    const pageData = extractPageContent();
                    resultsDiv.innerHTML = `✅ 内容提取成功！

📄 页面标题: ${pageData.title}
🔗 页面URL: ${pageData.url}
📏 内容长度: ${pageData.content.length} 字符

📝 内容预览:
${pageData.content.substring(0, 500)}...

📊 提取统计:
- 是否包含导航内容: ${pageData.content.includes('首页') || pageData.content.includes('关于') ? '❌ 是' : '✅ 否'}
- 是否包含侧边栏内容: ${pageData.content.includes('侧边栏') ? '❌ 是' : '✅ 否'}
- 是否包含页脚内容: ${pageData.content.includes('© 2024') ? '❌ 是' : '✅ 否'}
- 是否包含主要内容: ${pageData.content.includes('人工智能在医疗领域') ? '✅ 是' : '❌ 否'}
- 是否包含技术细节: ${pageData.content.includes('深度学习算法') ? '✅ 是' : '❌ 否'}`;
                } catch (error) {
                    resultsDiv.innerHTML = `❌ 内容提取失败: ${error.message}`;
                }
            }, 100);
        }
        
        function showPageStructure() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            let structure = '📋 页面结构分析:\n\n';
            
            // 分析页面结构
            const elements = document.querySelectorAll('div, section, article, main, header, footer, nav, aside');
            elements.forEach(element => {
                const tagName = element.tagName.toLowerCase();
                const className = element.className;
                const id = element.id;
                const textLength = element.textContent.trim().length;
                
                if (textLength > 50) { // 只显示有内容的元素
                    structure += `${tagName}${className ? '.' + className.split(' ')[0] : ''}${id ? '#' + id : ''} (${textLength}字符)\n`;
                }
            });
            
            resultsDiv.innerHTML = structure;
        }
        
        function clearResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
        }
        
        // 如果被扩展调用，返回提取的内容
        if (window.chrome && window.chrome.runtime) {
            chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
                if (request.action === 'extractContent') {
                    sendResponse({
                        success: true,
                        data: extractPageContent()
                    });
                }
            });
        }
    </script>
</body>
</html>
